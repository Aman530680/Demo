<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Peer Tutor Matchmaker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
    <div class="container">
        <a class="navbar-brand" href="/dashboard">ðŸ§  Matchmaker</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link" href="#">Profile</a></li>
                <li class="nav-item"><a class="nav-link" href="#">Find Tutors</a></li>
                <li class="nav-item"><a class="nav-link" href="#">My Sessions</a></li>
                <li class="nav-item"><a class="nav-link" href="#">Notifications</a></li>
            </ul>
            <form th:action="@{/login}" method="GET" class="d-flex">
                <span class="navbar-text text-white me-3" th:text="'Role: ' + ${userRole}">Role: STUDENT</span>
                <button type="submit" class="btn btn-danger btn-sm">Logout</button>
            </form>
        </div>
    </div>
</nav>

<div class="container mt-5">
    <div class="alert alert-success" role="alert">
        Welcome to your Dashboard! You are logged in as a <strong th:text="${userRole}">[ROLE]</strong>.
    </div>

    <div class="card shadow-sm p-4">
        <h2 class="card-title mb-4">Dashboard Overview</h2>
        <p>Your User ID: <code id="userIdDisplay" th:text="${userId}"></code></p>
        <p>Your JWT Token (Should be stored securely, passed via FlashAttribute):</p>
        <pre class="bg-gray-100 p-3 rounded-lg text-sm overflow-auto" id="jwtTokenDisplay" th:text="${jwtToken}">JWT TOKEN WILL APPEAR HERE</pre>

        <hr>

        <div th:if="${userRole == 'STUDENT'}">
            <h3 class="text-primary">Student Center</h3>
            <p>Find the best tutor for your next subject or view your booked sessions.</p>
            <a th:href="@{/sessions}" class="btn btn-primary me-2">Schedule Session</a>
            <a th:href="@{/feedback}" class="btn btn-outline-secondary">Give Feedback</a>
        </div>

        <div th:if="${userRole == 'TUTOR'}">
            <h3 class="text-success">Tutor Center</h3>
            <p>Manage your profile, skills, and upcoming session schedule.</p>
            <a th:href="@{/profile}" class="btn btn-success me-2">Update Profile/Skills</a>
            <a th:href="@{/sessions}" class="btn btn-outline-success">View Appointments</a>
        </div>

        <div th:if="${userRole == 'ADMIN'}">
            <h3 class="text-danger">Admin Panel</h3>
            <p>Access global user and session management tools.</p>
            <a th:href="@{/admin}" class="btn btn-danger">Manage System</a>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*
     * CRITICAL: This script extracts the JWT and user data passed from the controller
     * via Flash Attributes and saves it to localStorage, enabling subsequent API calls
     * to be authenticated.
     */
    const jwtToken = [[${jwtToken}]];
    const userId = [[${userId}]];
    const userRole = [[${userRole}]];

    if (jwtToken && userId && userRole) {
        // Save to localStorage
        localStorage.setItem('jwtToken', jwtToken);
        localStorage.setItem('userId', userId);
        localStorage.setItem('userRole', userRole);

        // Ensure the data is displayed correctly
        document.getElementById('jwtTokenDisplay').textContent = jwtToken;
        document.getElementById('userIdDisplay').textContent = userId;
    } else {
        // Fallback: If no token is present, check localStorage. If still missing, redirect to login.
        if (!localStorage.getItem('jwtToken')) {
            window.location.href = '/login';
        } else {
            // Load from localStorage if user is refreshing the page
            document.getElementById('jwtTokenDisplay').textContent = localStorage.getItem('jwtToken');
            document.getElementById('userIdDisplay').textContent = localStorage.getItem('userId');
        }
    }
</script>
</body>
</html>